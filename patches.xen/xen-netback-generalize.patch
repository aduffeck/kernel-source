From: jbeulich@suse.com
Subject: netback: fix flipping mode
Patch-mainline: Never, SUSE-Xen specific
References: bsc#996664

Filling the grant transfer operation's MFN value needs to be done
before changing the PFN <-> MFN translation. Move the setting of all
gop fields ahead.

--- a/drivers/xen/netback/netback.c
+++ b/drivers/xen/netback/netback.c
@@ -495,6 +495,11 @@ static void netbk_gop_frag(netif_t *neti
 		copy_gop->dest.u.ref = req->gref;
 		copy_gop->len = size;
 	} else {
+		gop = npo->trans - npo->trans_prod++;
+		gop->mfn = pfn_to_mfn(page_to_pfn(page));
+		gop->domid = netif->domid;
+		gop->ref = req->gref;
+
 		if (!xen_feature(XENFEAT_auto_translated_physmap)) {
 			unsigned long new_mfn =
 				alloc_mfn(&xen_netbk[GET_GROUP_INDEX(netif)].rx);
@@ -517,11 +522,6 @@ static void netbk_gop_frag(netif_t *neti
 				MMU_MACHPHYS_UPDATE;
 			mmu->val = page_to_pfn(page);
 		}
-
-		gop = npo->trans - npo->trans_prod++;
-		gop->mfn = virt_to_mfn(page_address(page));
-		gop->domid = netif->domid;
-		gop->ref = req->gref;
 	}
 	meta->id = req->id;
 }
